<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1, h2, h3 { color: #ffffff; font-weight: 500; }
        .metric-wrapper { margin-bottom: 20px; }

        .summary-item {
            background-color: #1e1e1e;
            padding: 20px 25px 30px;
            border-radius: 12px;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 190px;
        }

        .summary-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }

        .summary-item h2 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-scale-container {
            position: relative;
            height: 80px;
            margin: 0;
            flex-shrink: 0;
        }

        .scale-wrapper {
            position: relative;
            height: 100%;
            margin: 0 45px;
        }

        .score-scale-bar { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; height: 10px; border-radius: 5px; }
        .scale-pointer { position: absolute; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }

        .pointer-avg { top: 5px; border-bottom: 12px solid; }
        .pointer-last { top: 63px; border-top: 12px solid; }

        .pointer-label {
            font-size: 0.8em;
            color: #ccc;
            background-color: rgba(0,0,0,0.8);
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .pointer-avg .pointer-label { position: absolute; bottom: 14px; transform: translateX(-50%); }
        .pointer-last .pointer-label { position: absolute; top: 14px; transform: translateX(-50%); }

        .details-container { display: none; flex-direction: column; gap: 30px; margin-top: 20px; }
        .details-container.visible { display: flex; }
        .chart-wrapper { background-color: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-subtitle { margin-top: -10px; margin-bottom: 20px; font-size: 0.9em; color: #999; }
        .vo2-chart-container { position: relative; }
        .vo2-gradient-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; border-radius: 8px; z-index: 1; }
        #vo2-max-chart { position: relative; z-index: 2; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <h1>Health Analysis</h1>

        <div class="metric-wrapper">
            <div id="sleep-summary" class="summary-item">
                <h2>Sleep Score üò¥</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="sleep-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="sleep-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="sleep-details" class="details-container">
                <div class="chart-wrapper"><h3>Sleep Windows</h3><p class="chart-subtitle">Sleep periods showing time in bed. Color indicates sleep consistency.</p><div style="height: 300px; position: relative;"><canvas id="sleep-windows-chart"></canvas></div></div>
                <div class="chart-wrapper"><h3>Sleep Duration</h3><p class="chart-subtitle">Total hours slept each day.</p><div style="height: 300px; position: relative;"><canvas id="sleep-duration-chart"></canvas></div></div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="vo2-summary" class="summary-item">
                <h2>VO2 Max Score üí™</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="vo2-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="vo2-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="vo2-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>VO2 Max Trend</h3>
                    <p class="chart-subtitle">Your estimated VO2 max over time. Higher is better.</p>
                    <div class="vo2-chart-container">
                    <canvas id="vo2-max-chart"></canvas>
                        <div id="vo2-gradient-bg" class="vo2-gradient-bg"></div>
                    </div>
                    <div id="vo2-zones-data" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="steps-summary" class="summary-item">
                <h2>Steps Score üö∂</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="steps-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="steps-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="steps-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>Daily Steps</h3>
                    <p class="chart-subtitle">Daily steps with 7-day rolling average. Color indicates health risk based on steps.</p>
                    <canvas id="steps-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="strength-summary" class="summary-item">
                <h2>Strength Training Score üí™</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="strength-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="strength-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="strength-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>Strength Training</h3>
                    <p class="chart-subtitle">Daily strength training duration with 7-day rolling sum. Color indicates heart rate multiplier based on weekly volume.</p>
                    <canvas id="strength-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="bodyComp-summary" class="summary-item">
                <h2>Body Composition Score üèãÔ∏è</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="bodyComp-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="bodyComp-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="bodyComp-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>Body Composition Trends</h3>
                    <p class="chart-subtitle">Weight, body fat percentage, FFMI, and FMI over time. Color indicates health risk based on FFMI.</p>
                    <div style="height: 300px; position: relative;">
                        <canvas id="bodyComp-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="rhr-summary" class="summary-item">
                <h2>Resting Heart Rate Score ‚ù§Ô∏è</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="rhr-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="rhr-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="rhr-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>Resting Heart Rate Trends</h3>
                    <p class="chart-subtitle">Daily resting heart rate in BPM over time. Color indicates health risk based on hazard ratios.</p>
                    <div style="height: 300px; position: relative;">
                        <canvas id="rhr-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA PLACEHOLDER (To be replaced by Python) ---
        const chartData = {
    "sleep": {
        "latestScore": 2.5413249895253465,
        "averageScore": 1.6079722198501245,
        "daily": [
            {
                "label": "Sep 2025",
                "consistencyScore": 1.2751405530286004,
                "durationScore": 1.1845915309106099,
                "consistencyColor": "#e53935",
                "durationColor": "#e53935",
                "sleepTime": "22:35",
                "wakeTime": "07:20",
                "sleepDuration": 7.599404761904762,
                "timeInBed": 8.00297619047619,
                "awakeCount": 2,
                "hasData": true
            },
            {
                "label": "Aug 2025",
                "consistencyScore": 1.1323395424284401,
                "durationScore": 1.1116648833622518,
                "consistencyColor": "#e53935",
                "durationColor": "#e53935",
                "sleepTime": "22:33",
                "wakeTime": "07:18",
                "sleepDuration": 7.712258852258852,
                "timeInBed": 8.087716727716728,
                "awakeCount": 2,
                "hasData": true
            },
            {
                "label": "Jul 2025",
                "consistencyScore": 1.1400000000000001,
                "durationScore": 1.2480645161290322,
                "consistencyColor": "#e53935",
                "durationColor": "#e53935",
                "sleepTime": "22:30",
                "wakeTime": "07:15",
                "sleepDuration": 7.676505376344086,
                "timeInBed": 8.171129032258065,
                "awakeCount": 3,
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "vo2": {
        "latestScore": 1.35,
        "averageScore": -2.441954022988506,
        "daily": [
            {
                "date": "Sep 2025",
                "vo2": 53.92333333333333
            },
            {
                "date": "Aug 2025",
                "vo2": 53.47931034482759
            },
            {
                "date": "Jul 2025",
                "vo2": 46.35
            }
        ],
        "zones": [
            {
                "value": 36.05,
                "color": "#e53935"
            },
            {
                "value": 38.85,
                "color": "#e53935"
            },
            {
                "value": 44.8,
                "color": "#ffffff"
            },
            {
                "value": 51.28,
                "color": "#43a047"
            },
            {
                "value": 54.95,
                "color": "#43a047"
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "steps": {
        "latestScore": 0.0,
        "averageScore": 2.0012820512820517,
        "daily": [
            {
                "label": "Sep 2025",
                "dailySteps": 13814,
                "rollingAvgSteps": 13753,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Aug 2025",
                "dailySteps": 9655,
                "rollingAvgSteps": 8446,
                "hazardRatio": 1.4603846153846154,
                "hrColor": "#e53935",
                "hasData": true
            },
            {
                "label": "Jul 2025",
                "dailySteps": 8700,
                "rollingAvgSteps": 7920,
                "hazardRatio": 1.1400000000000001,
                "hrColor": "#e53935",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "strength": {
        "latestScore": -0.05740944436693929,
        "averageScore": 0.3389555560180857,
        "daily": [
            {
                "label": "Sep 2025",
                "dailyDuration": 20.240428805881077,
                "weeklySum": 100.82497483995226,
                "hrScore": 0.9942590555633061,
                "hrColor": "#e9f4e9",
                "hasData": true
            },
            {
                "label": "Aug 2025",
                "dailyDuration": 24.237059759324595,
                "weeklySum": 162.0100819577453,
                "hrScore": 0.9874276112421194,
                "hrColor": "#cfe7d0",
                "hasData": true
            },
            {
                "label": "Jul 2025",
                "dailyDuration": 36.0,
                "weeklySum": 224.0,
                "hrScore": 1.12,
                "hrColor": "#e53935",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "bodyComp": {
        "latestScore": 2.733194540652659,
        "averageScore": 2.8443981802175533,
        "daily": [
            {
                "label": "Sep 2025",
                "weight": 84.30031034482758,
                "bodyFat": 18.50172413793103,
                "ffmi": 20.310043132717254,
                "fmi": 4.2245851902873826,
                "hrScore": 1.273319454065266,
                "hrColor": "#e53935",
                "hasData": true
            },
            {
                "label": "Aug 2025",
                "weight": 74.4,
                "bodyFat": 17.2,
                "ffmi": 18.88,
                "fmi": 3.44,
                "hrScore": 1.4400000000000002,
                "hrColor": "#e53935",
                "hasData": true
            },
            {
                "label": "Jul 2025",
                "weight": 71.4,
                "bodyFat": 15.7,
                "ffmi": 18.279999999999998,
                "fmi": 3.14,
                "hrScore": 1.1400000000000001,
                "hrColor": "#e53935",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "rhr": {
        "latestScore": -1.6893666666666662,
        "averageScore": -1.681412544802866,
        "daily": [
            {
                "label": "Sep 2025",
                "rhr": 48,
                "hrScore": 0.8310633333333334,
                "hrColor": "#43a047",
                "hasData": true
            },
            {
                "label": "Aug 2025",
                "rhr": 47,
                "hrScore": 0.8220129032258066,
                "hrColor": "#43a047",
                "hasData": true
            },
            {
                "label": "Jul 2025",
                "rhr": 50,
                "hrScore": 0.8425,
                "hrColor": "#43a047",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    }
};

        document.addEventListener('DOMContentLoaded', function() {
            Chart.register(ChartDataLabels);

            // --- Accordion Click Logic ---
            document.querySelectorAll('.summary-item').forEach(summary => {
                summary.addEventListener('click', function() {
                    const detailsId = this.id.replace('-summary', '-details');
                    const detailsEl = document.getElementById(detailsId);
                    if (!detailsEl) return;
                    const isAlreadyVisible = detailsEl.classList.contains('visible');
                    document.querySelectorAll('.details-container').forEach(d => d.classList.remove('visible'));
                    if (!isAlreadyVisible) detailsEl.classList.add('visible');
                });
            });

            // --- Reusable Helper Functions ---
            const hexToRgba = (hex, alpha=1) => { if(!hex) return 'rgba(136,136,136,0.6)'; const [r,g,b] = hex.match(/\w\w/g).map(x=>parseInt(x,16)); return `rgba(${r},${g},${b},${alpha})`; };
            const timeToDecimal = (t) => { if (!t) return null; const [h,m] = t.split(':').map(Number); return h + m / 60; };
            const decimalToTime = (d) => { if (!d) return 'N/A'; const h = Math.floor(d)%24, m = Math.round((d%1)*60); return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; };
            const getContrastColor = (hex) => { if(!hex) return '#FFFFFF'; const [r,g,b] = hex.match(/\w\w/g).map(x => parseInt(x, 16)); return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#000000' : '#FFFFFF'; };

            // --- FIXED HELPER FUNCTIONS ---

            const scoreToPercentage = (score, stops) => {
                const allScores = stops.map(s => s.score);
                const minScore = Math.min(...allScores);
                const maxScore = Math.max(...allScores);

                const scoreRange = maxScore - minScore;
                if (scoreRange === 0) return 50;

                const boundedScore = Math.max(minScore, Math.min(score, maxScore));

                return ((boundedScore - minScore) / scoreRange) * 100;
            };

            const getColorForScore = (score, stops) => {
                const sortedStops = [...stops].sort((a, b) => a.score - b.score);

                if (score <= sortedStops[0].score) return sortedStops[0].color;
                if (score >= sortedStops[sortedStops.length - 1].score) return sortedStops[sortedStops.length - 1].color;

                let stop1, stop2;
                for (let i = 0; i < sortedStops.length - 1; i++) {
                    if (score >= sortedStops[i].score && score <= sortedStops[i+1].score) {
                        stop1 = sortedStops[i];
                        stop2 = sortedStops[i+1];
                        break;
                    }
                }

                const range = stop2.score - stop1.score;
                const ratio = range === 0 ? 0 : (score - stop1.score) / range;

                const r1 = parseInt(stop1.color.slice(1,3), 16), g1 = parseInt(stop1.color.slice(3,5), 16), b1 = parseInt(stop1.color.slice(5,7), 16);
                const r2 = parseInt(stop2.color.slice(1,3), 16), g2 = parseInt(stop2.color.slice(3,5), 16), b2 = parseInt(stop2.color.slice(5,7), 16);

                const R = Math.round(r1 * (1-ratio) + r2 * ratio);
                const G = Math.round(g1 * (1-ratio) + g2 * ratio);
                const B = Math.round(b1 * (1-ratio) + b2 * ratio);

                return `rgb(${R}, ${G}, ${B})`;
            };

            function setupPointers(prefix, lastScore, avgScore, stops) {
                const lastPointer = document.getElementById(`${prefix}-last-pointer`);
                const avgPointer = document.getElementById(`${prefix}-avg-pointer`);

                lastPointer.style.left = `${scoreToPercentage(lastScore, stops)}%`;
                avgPointer.style.left = `${scoreToPercentage(avgScore, stops)}%`;

                lastPointer.style.borderTopColor = getColorForScore(lastScore, stops);
                avgPointer.style.borderBottomColor = getColorForScore(avgScore, stops);

                const lastLabel = lastPointer.querySelector('.pointer-label');
                const avgLabel = avgPointer.querySelector('.pointer-label');

                if (lastLabel) lastLabel.textContent = `Last: ${lastScore.toFixed(2)}`;
                if (avgLabel) avgLabel.textContent = `Avg: ${avgScore.toFixed(2)}`;
            }

            function updateGradientBar(prefix, stops) {
                const gradientString = [...stops]
                    .sort((a, b) => a.score - b.score)
                    .map(stop =>
                        `${stop.color} ${scoreToPercentage(stop.score, stops)}%`
                    )
                    .join(', ');

                const bar = document.querySelector(`#${prefix}-summary .score-scale-bar`);
                if(bar) bar.style.background = `linear-gradient(to right, ${gradientString})`;
            }

            // --- Setup Section for SLEEP ---
            if (chartData && chartData.sleep) {
                const sleepData = chartData.sleep;
                updateGradientBar('sleep', sleepData.colorStops);
                setupPointers('sleep', sleepData.latestScore, sleepData.averageScore, sleepData.colorStops);
                createSleepCharts(sleepData);
            }

            // --- Setup Section for VO2 MAX ---
            if (chartData && chartData.vo2) {
                const vo2Data = chartData.vo2;
                updateGradientBar('vo2', vo2Data.colorStops);
                setupPointers('vo2', vo2Data.latestScore, vo2Data.averageScore, vo2Data.colorStops);
                createVo2MaxChart(vo2Data);
            }

            // --- Setup Section for STEPS ---
            if (chartData && chartData.steps) {
                const stepsData = chartData.steps;
                updateGradientBar('steps', stepsData.colorStops);
                setupPointers('steps', stepsData.latestScore, stepsData.averageScore, stepsData.colorStops);
                createStepsChart(stepsData);
            }

            // --- Setup Section for STRENGTH TRAINING ---
            if (chartData && chartData.strength) {
                const strengthData = chartData.strength;
                updateGradientBar('strength', strengthData.colorStops);
                setupPointers('strength', strengthData.latestScore, strengthData.averageScore, strengthData.colorStops);
                createStrengthChart(strengthData);
            }

            // --- Setup Section for BODY COMPOSITION ---
            if (chartData && chartData.bodyComp) {
                const bodyCompData = chartData.bodyComp;
                updateGradientBar('bodyComp', bodyCompData.colorStops);
                setupPointers('bodyComp', bodyCompData.latestScore, bodyCompData.averageScore, bodyCompData.colorStops);
                createBodyCompChart(bodyCompData);
            }

            // --- Setup Section for RESTING HEART RATE ---
            if (chartData && chartData.rhr) {
                const rhrData = chartData.rhr;
                updateGradientBar('rhr', rhrData.colorStops);
                setupPointers('rhr', rhrData.latestScore, rhrData.averageScore, rhrData.colorStops);
                createRhrChart(rhrData);
            }

            // --- Chart Creation Functions ---
            function createSleepCharts(sleepData) {
                // Handle missing days - filter out days without data
                const validDays = sleepData.daily.filter(d => d.hasData);

                // Create forest plot-style sleep windows chart
                const sleepWindowsData = validDays.map(d => {
                    const sleepTime = timeToDecimal(d.sleepTime);
                    const wakeTime = timeToDecimal(d.wakeTime);
                    const timeInBed = d.timeInBed || d.sleepDuration || 0; // Use actual time in bed

                    // Calculate the actual end time (sleep time + time in bed)
                    let endTime = sleepTime + timeInBed;

                    // Handle day rollover (if sleep goes past midnight)
                    if (endTime >= 24) {
                        endTime = endTime - 24;
                    }

                    return {
                        sleepTime: sleepTime,
                        wakeTime: wakeTime,
                        timeInBed: timeInBed,
                        endTime: endTime,
                        consistencyScore: d.consistencyScore,
                        awakeCount: d.awakeCount || 0
                    };
                });

                // Custom plugin to draw sleep period bars and handle tooltips
                const sleepBarPlugin = {
                    id: 'sleepBarPlugin',
                    beforeDatasetsDraw(chart) {
                        const { ctx, scales: { x, y } } = chart;
                        
                        sleepWindowsData.forEach((sleepData, index) => {
                            let startTime = sleepData.sleepTime;
                            let endTime = sleepData.sleepTime + sleepData.timeInBed;
                            
                            // Adjust times for the 18-42 hour range (6pm to 6pm next day)
                            // If sleep time is before 18:00 (6pm), it belongs to the next day
                            if (startTime < 18) {
                                startTime += 24; // Move to next day
                            }
                            if (endTime < 18) {
                                endTime += 24; // Move to next day
                            }
                            
                            // Set color based on consistency score
                            const score = sleepData.consistencyScore || 1.0;
                            let backgroundColor, borderColor;

                            if (score <= 0.9) {
                                backgroundColor = '#4caf50';
                                borderColor = '#2e7d32';
                            } else if (score >= 1.5) {
                                backgroundColor = '#f44336';
                                borderColor = '#c62828';
                            } else {
                                // Gradient between green and red for middle values
                                const ratio = (score - 0.9) / (1.5 - 0.9);
                                const r = Math.round(76 + (244 - 76) * ratio);
                                const g = Math.round(175 + (67 - 175) * ratio);
                                const b = Math.round(80 + (54 - 80) * ratio);
                                backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                borderColor = `rgb(${Math.round(46 + (198 - 46) * ratio)}, ${Math.round(125 + (40 - 125) * ratio)}, ${Math.round(50 + (40 - 50) * ratio)})`;
                            }
                            
                            // Get pixel positions
                            const startPixel = x.getPixelForValue(startTime);
                            const endPixel = x.getPixelForValue(endTime);
                            const barHeight = 12; // Fixed bar height
                            const barY = y.getPixelForValue(index) - barHeight / 2;
                            
                            // Draw single continuous bar (no midnight crossing needed with 18-42 range)
                            ctx.fillStyle = backgroundColor;
                            ctx.fillRect(startPixel, barY, endPixel - startPixel, barHeight);
                            
                            // Draw border
                            ctx.strokeStyle = borderColor;
                            ctx.lineWidth = 1.5;
                            ctx.strokeRect(startPixel, barY, endPixel - startPixel, barHeight);
                        });
                    },
                    
                    // Add tooltip functionality
                    afterEvent(chart, event) {
                        const { x, y } = event;
                        const { scales } = chart;
                        
                        // Check if mouse is over any sleep bar
                        let hoveredBar = null;
                        
                        sleepWindowsData.forEach((sleepData, index) => {
                            let startTime = sleepData.sleepTime;
                            let endTime = sleepData.sleepTime + sleepData.timeInBed;
                            
                            // Adjust times for the 18-42 hour range
                            if (startTime < 18) {
                                startTime += 24;
                            }
                            if (endTime < 18) {
                                endTime += 24;
                            }
                            
                            const startPixel = scales.x.getPixelForValue(startTime);
                            const endPixel = scales.x.getPixelForValue(endTime);
                            const barHeight = 12;
                            const barY = scales.y.getPixelForValue(index) - barHeight / 2;
                            
                            // Check if mouse is within the bar bounds
                            if (x >= startPixel && x <= endPixel && y >= barY && y <= barY + barHeight) {
                                hoveredBar = { sleepData, index };
                            }
                        });
                        
                        // Update cursor style
                        chart.canvas.style.cursor = hoveredBar ? 'pointer' : 'default';
                        
                        // Store hovered bar for tooltip
                        chart.hoveredSleepBar = hoveredBar;
                    }
                };

                // Custom tooltip plugin for sleep bars
                const sleepTooltipPlugin = {
                    id: 'sleepTooltipPlugin',
                    afterDraw(chart) {
                        if (chart.hoveredSleepBar) {
                            const { sleepData, index } = chart.hoveredSleepBar;
                            const { ctx, scales } = chart;
                            
                            // Get mouse position
                            const mouseX = chart.canvas.getBoundingClientRect().left + chart.canvas.width / 2;
                            const mouseY = chart.canvas.getBoundingClientRect().top + chart.canvas.height / 2;
                            
                            // Create tooltip content
                            const sleepTime = decimalToTime(sleepData.sleepTime);
                            const wakeTime = decimalToTime(sleepData.wakeTime);
                            const timeInBed = sleepData.timeInBed.toFixed(1);
                            const consistencyScore = sleepData.consistencyScore ? sleepData.consistencyScore.toFixed(2) : 'N/A';
                            const awakeCount = sleepData.awakeCount || 0;
                            
                            const tooltipText = [
                                `Sleep Time: ${sleepTime}`,
                                `Wake Time: ${wakeTime}`,
                                `Time in Bed: ${timeInBed}h`,
                                `Sleep Consistency: ${consistencyScore}`,
                                `Awake Count: ${awakeCount}`
                            ];
                            
                            // Draw tooltip background
                            const padding = 8;
                            const lineHeight = 16;
                            const maxWidth = Math.max(...tooltipText.map(text => ctx.measureText(text).width));
                            const tooltipWidth = maxWidth + padding * 2;
                            const tooltipHeight = tooltipText.length * lineHeight + padding * 2;
                            
                            const tooltipX = mouseX - tooltipWidth / 2;
                            const tooltipY = mouseY - tooltipHeight - 10;
                            
                            // Draw background
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                            ctx.fillRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);
                            
                            // Draw border
                            ctx.strokeStyle = '#666';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);
                            
                            // Draw text
                            ctx.fillStyle = '#fff';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'left';
                            
                            tooltipText.forEach((text, i) => {
                                ctx.fillText(text, tooltipX + padding, tooltipY + padding + (i + 1) * lineHeight);
                            });
                        }
                    }
                };

                // Create horizontal bar chart for sleep windows (forest plot style)
                new Chart('sleep-windows-chart', {
                    type: 'bar',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [{
                            label: 'Sleep Window',
                            data: sleepWindowsData.map(d => 0), // Dummy data - we'll draw custom bars
                            backgroundColor: 'transparent',
                            borderColor: 'transparent',
                            borderWidth: 0
                        }]
                    },
                    plugins: [sleepBarPlugin, sleepTooltipPlugin],
                    options: {
                        animation: false, // Disable animations to prevent resizing issues
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Horizontal bars
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10
                            }
                        },
                        scales: {
                            x: {
                                min: 18,
                                max: 42, // 18 + 24 = 42 (6pm to 6pm next day)
                                title: {
                                    display: true,
                                    text: 'Time of Day',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    stepSize: 2,
                                    callback: function(value) {
                                        // Convert decimal hours to time format
                                        const hours = Math.floor(value);
                                        const minutes = Math.round((value - hours) * 60);
                                        const displayHours = hours % 24;
                                        return `${String(displayHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                    }
                                }
                            },
                            y: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: false // Disable default tooltips since we have custom ones
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });

                // Duration chart - simple bar chart showing hours slept
                const durationData = validDays.map(d => d.sleepDuration || 0);

                new Chart('sleep-duration-chart', {
                    type: 'bar',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [{
                            label: 'Hours Slept',
                            data: durationData,
                            backgroundColor: validDays.map(d => hexToRgba(d.durationColor, 0.6)),
                            borderColor: validDays.map(d => d.durationColor),
                            borderWidth: 1.5
                        }]
                    },
                    options: {
                        animation: false, // Disable animations to prevent resizing issues
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    callback: function(value) {
                                        return value.toFixed(1) + 'h';
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Hours Slept: ${context.raw.toFixed(1)}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }

            function createVo2MaxChart(vo2Data) {
                const dailyData = vo2Data.daily;
                const zones = vo2Data.zones || []; // Get zones from your data, default to empty array

                // Dynamically determine the Y-axis range to fit all data points and zone lines
                const allYValues = [...dailyData.map(d => d.vo2), ...zones.map(z => z.value)];
                const yMax = Math.ceil(Math.max(...allYValues)) + 2;
                const yMin = Math.floor(Math.min(...allYValues)) - 2;

                // --- GRADIENT BACKGROUND LOGIC ---
                const annotations = {};

                // Create gradient background for VO2 chart
                if (zones.length > 0) {
                    const sortedZones = [...zones].sort((a, b) => a.value - b.value);
                    const gradientElement = document.getElementById('vo2-gradient-bg');

                    if (gradientElement) {
                        // Create CSS gradient string
                        const gradientStops = sortedZones.map((zone, index) => {
                            const percentage = ((zone.value - yMin) / (yMax - yMin)) * 100;
                            return `${zone.color} ${percentage}%`;
                        }).join(', ');

                        gradientElement.style.background = `linear-gradient(to top, ${gradientStops})`;
                    }
                }
                // --- END OF GRADIENT BACKGROUND LOGIC ---

                new Chart('vo2-max-chart', {
                    type: 'line',
                    data: {
                        labels: dailyData.map(d => d.date),
                        datasets: [{
                            data: dailyData.map(d => d.vo2),
                            borderColor: '#64b5f6',
                            backgroundColor: hexToRgba('#64b5f6', 0.2),
                            fill: true,
                            pointBackgroundColor: '#FFFFFF',
                            pointBorderColor: '#64b5f6',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.1
                        }]
                    },
                    options: {
                        animation: false, // <--- This line disables animations for the chart
                        scales: {
                            y: { min: yMin, max: yMax, title: { display: true, text: 'VO2 Max', color: '#aaa' }, ticks: { color: '#aaa' } },
                            x: { ticks: { color: '#aaa' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: c => `VO2 Max: ${parseFloat(c.raw).toFixed(2)}` } },
                            datalabels: { anchor: 'end', align: 'top', color: '#ccc', formatter: (v) => parseFloat(v).toFixed(2) }
                        }
                    }
                });
            }

            function createStepsChart(stepsData) {
                const dailyData = stepsData.daily;
                const labels = dailyData.map(d => d.label);
                const dailySteps = dailyData.map(d => d.dailySteps);
                const rollingAvgSteps = dailyData.map(d => d.rollingAvgSteps);
                const hrColors = dailyData.map(d => d.hrColor);

                new Chart('steps-chart', {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Daily Steps',
                                data: dailySteps,
                                backgroundColor: hrColors,
                                borderColor: hrColors,
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '7-Day Rolling Average',
                                data: rollingAvgSteps,
                                type: 'line',
                                borderColor: '#ff9800',
                                backgroundColor: 'transparent',
                                pointBackgroundColor: '#ff9800',
                                pointBorderColor: '#ff9800',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        animation: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Steps',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#aaa',
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Daily Steps: ${context.raw.toLocaleString()}`;
                                        } else {
                                            return `Rolling Average: ${context.raw.toLocaleString()}`;
                                        }
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }

            function createStrengthChart(strengthData) {
                const dailyData = strengthData.daily;
                const labels = dailyData.map(d => d.label);
                const dailyDuration = dailyData.map(d => d.dailyDuration);
                const weeklySum = dailyData.map(d => d.weeklySum);
                const hrColors = dailyData.map(d => d.hrColor);

                new Chart('strength-chart', {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Daily Duration (min)',
                                data: dailyDuration,
                                backgroundColor: hrColors,
                                borderColor: hrColors,
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '7-Day Rolling Sum (min)',
                                data: weeklySum,
                                type: 'line',
                                borderColor: '#ff9800',
                                backgroundColor: 'transparent',
                                pointBackgroundColor: '#ff9800',
                                pointBorderColor: '#ff9800',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        animation: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Minutes',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    callback: function(value) {
                                        return value.toFixed(0);
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#aaa',
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Daily Duration: ${context.raw.toFixed(1)} min`;
                                        } else {
                                            return `Weekly Sum: ${context.raw.toFixed(1)} min`;
                                        }
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }

            function createBodyCompChart(bodyCompData) {
                // Handle missing days - filter out days without data
                const validDays = bodyCompData.daily.filter(d => d.hasData);
                
                if (validDays.length === 0) {
                    console.log('No body composition data available');
                    return;
                }

                const ctx = document.getElementById('bodyComp-chart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [
                            {
                                label: 'Weight (kg)',
                                data: validDays.map(d => d.weight),
                                backgroundColor: validDays.map(d => hexToRgba(d.hrColor, 0.7)),
                                borderColor: validDays.map(d => d.hrColor),
                                borderWidth: 2,
                                yAxisID: 'y',
                                order: 2
                            },
                            {
                                label: 'FFMI',
                                data: validDays.map(d => d.ffmi),
                                borderColor: '#2196F3',
                                backgroundColor: hexToRgba('#2196F3', 0.1),
                                yAxisID: 'y1',
                                tension: 0.3,
                                pointBackgroundColor: validDays.map(d => d.hrColor),
                                pointBorderColor: validDays.map(d => d.hrColor),
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                borderWidth: 3,
                                type: 'line',
                                order: 1
                            },
                            {
                                label: 'FMI',
                                data: validDays.map(d => d.fmi),
                                borderColor: '#FF9800',
                                backgroundColor: hexToRgba('#FF9800', 0.1),
                                yAxisID: 'y1',
                                tension: 0.3,
                                pointBackgroundColor: validDays.map(d => d.hrColor),
                                pointBorderColor: validDays.map(d => d.hrColor),
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                borderWidth: 3,
                                type: 'line',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 0
                        },
                        transitions: {
                            active: {
                                animation: {
                                    duration: 0
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Weight (kg)',
                                    color: '#4CAF50',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    color: '#4CAF50',
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'FFMI & FMI',
                                    color: '#2196F3',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    color: '#2196F3',
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#aaa',
                                    maxRotation: 45,
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#aaa',
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    },
                                    padding: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const value = context.raw;
                                        
                                        if (datasetLabel === 'Weight (kg)') {
                                            return `Weight: ${value.toFixed(1)} kg`;
                                        } else if (datasetLabel === 'FFMI') {
                                            return `FFMI: ${value.toFixed(2)}`;
                                        } else if (datasetLabel === 'FMI') {
                                            return `FMI: ${value.toFixed(2)}`;
                                        }
                                        return `${datasetLabel}: ${value.toFixed(2)}`;
                                    },
                                    afterLabel: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const day = validDays[dataIndex];
                                        return `HR Score: ${day.hrScore.toFixed(3)}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }

            function createRhrChart(rhrData) {
                // Handle missing days - filter out days without data
                const validDays = rhrData.daily.filter(d => d.hasData);
                
                if (validDays.length === 0) {
                    console.log('No resting heart rate data available');
                    return;
                }

                const ctx = document.getElementById('rhr-chart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [
                            {
                                label: 'Resting Heart Rate (BPM)',
                                data: validDays.map(d => d.restingHeartRate),
                                borderColor: '#E91E63',
                                backgroundColor: hexToRgba('#E91E63', 0.1),
                                tension: 0.3,
                                pointBackgroundColor: validDays.map(d => d.hrColor),
                                pointBorderColor: validDays.map(d => d.hrColor),
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                borderWidth: 3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 0
                        },
                        transitions: {
                            active: {
                                animation: {
                                    duration: 0
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Resting Heart Rate (BPM)',
                                    color: '#E91E63',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    color: '#E91E63',
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#aaa',
                                    maxRotation: 45,
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#aaa',
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    },
                                    padding: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        return `RHR: ${value} BPM`;
                                    },
                                    afterLabel: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const day = validDays[dataIndex];
                                        return `HR Score: ${day.hrScore.toFixed(3)}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
