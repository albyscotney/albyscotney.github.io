<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1, h2, h3 { color: #ffffff; font-weight: 500; }
        .metric-wrapper { margin-bottom: 20px; }

        .summary-item {
            background-color: #1e1e1e;
            padding: 20px 25px 30px;
            border-radius: 12px;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 190px;
        }

        .summary-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }

        .summary-item h2 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-scale-container {
            position: relative;
            height: 80px;
            margin: 0;
            flex-shrink: 0;
        }

        .scale-wrapper {
            position: relative;
            height: 100%;
            margin: 0 45px;
        }

        .score-scale-bar { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; height: 10px; border-radius: 5px; }
        .scale-pointer { position: absolute; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }

        .pointer-avg { top: 5px; border-bottom: 12px solid; }
        .pointer-last { top: 63px; border-top: 12px solid; }

        .pointer-label {
            font-size: 0.8em;
            color: #ccc;
            background-color: rgba(0,0,0,0.8);
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .pointer-avg .pointer-label { position: absolute; bottom: 14px; transform: translateX(-50%); }
        .pointer-last .pointer-label { position: absolute; top: 14px; transform: translateX(-50%); }

        .details-container { display: none; flex-direction: column; gap: 30px; margin-top: 20px; }
        .details-container.visible { display: flex; }
        .chart-wrapper { background-color: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-subtitle { margin-top: -10px; margin-bottom: 20px; font-size: 0.9em; color: #999; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <h1>Health Analysis</h1>

        <div class="metric-wrapper">
            <div id="sleep-summary" class="summary-item">
                <h2>Sleep Score ðŸ˜´</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="sleep-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="sleep-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="sleep-details" class="details-container">
                <div class="chart-wrapper"><h3>Sleep & Wake Times</h3><p class="chart-subtitle">Sleep times (top) and wake times (bottom) for each day.</p><canvas id="sleep-consistency-chart"></canvas></div>
                <div class="chart-wrapper"><h3>Sleep Duration</h3><p class="chart-subtitle">Total hours slept each day.</p><canvas id="sleep-duration-chart"></canvas></div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="vo2-summary" class="summary-item">
                <h2>VO2 Max Score ðŸ’ª</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="vo2-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="vo2-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="vo2-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>VO2 Max Trend</h3>
                    <p class="chart-subtitle">Your estimated VO2 max over time. Higher is better.</p>
                    <canvas id="vo2-max-chart"></canvas>
                    <div id="vo2-zones-data" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA PLACEHOLDER (To be replaced by Python) ---
        const chartData = {
    "sleep": {
        "latestScore": -0.9488305752561066,
        "averageScore": 0.42215325177882956,
        "daily": [
            {
                "label": "Sep 21",
                "consistencyScore": 1.28,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": null,
                "wakeTime": null,
                "hasData": true
            },
            {
                "label": "Sep 22",
                "consistencyScore": 1.28,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:23",
                "wakeTime": "06:57",
                "hasData": true
            },
            {
                "label": "Sep 23",
                "consistencyScore": 1.28,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:19",
                "wakeTime": "06:52",
                "hasData": true
            },
            {
                "label": "Sep 24",
                "consistencyScore": 1.094749683143219,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:37",
                "wakeTime": "09:01",
                "hasData": true
            },
            {
                "label": "Sep 25",
                "consistencyScore": 0.9640504334121355,
                "durationScore": 0.93,
                "consistencyColor": "#77ba7a",
                "durationColor": "#43a047",
                "sleepTime": "22:38",
                "wakeTime": "06:21",
                "hasData": true
            },
            {
                "label": "Sep 26",
                "consistencyScore": 0.9725873391121618,
                "durationScore": 0.93,
                "consistencyColor": "#97ca9a",
                "durationColor": "#43a047",
                "sleepTime": "23:50",
                "wakeTime": "08:01",
                "hasData": true
            },
            {
                "label": "Sep 27",
                "consistencyScore": 0.97324402416601,
                "durationScore": 0.93,
                "consistencyColor": "#9acc9c",
                "durationColor": "#43a047",
                "sleepTime": "23:51",
                "wakeTime": "07:05",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "vo2": {
        "latestScore": 4.1,
        "averageScore": 4.1,
        "daily": [
            {
                "date": "Sep 27",
                "vo2": 40.0
            },
            {
                "date": "Sep 26",
                "vo2": 40.0
            },
            {
                "date": "Sep 25",
                "vo2": 40.0
            },
            {
                "date": "Sep 24",
                "vo2": 40.0
            },
            {
                "date": "Sep 23",
                "vo2": 40.0
            },
            {
                "date": "Sep 22",
                "vo2": 40.0
            },
            {
                "date": "Sep 21",
                "vo2": 40.0
            }
        ],
        "zones": [
            {
                "value": 36.05,
                "color": "#e53935"
            },
            {
                "value": 38.85,
                "color": "#e53935"
            },
            {
                "value": 44.8,
                "color": "#ffffff"
            },
            {
                "value": 51.28,
                "color": "#43a047"
            },
            {
                "value": 54.95,
                "color": "#43a047"
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    }
};

        document.addEventListener('DOMContentLoaded', function() {
            Chart.register(ChartDataLabels);

            // --- Accordion Click Logic ---
            document.querySelectorAll('.summary-item').forEach(summary => {
                summary.addEventListener('click', function() {
                    const detailsId = this.id.replace('-summary', '-details');
                    const detailsEl = document.getElementById(detailsId);
                    if (!detailsEl) return;
                    const isAlreadyVisible = detailsEl.classList.contains('visible');
                    document.querySelectorAll('.details-container').forEach(d => d.classList.remove('visible'));
                    if (!isAlreadyVisible) detailsEl.classList.add('visible');
                });
            });

            // --- Reusable Helper Functions ---
            const hexToRgba = (hex, alpha=1) => { if(!hex) return 'rgba(136,136,136,0.6)'; const [r,g,b] = hex.match(/\w\w/g).map(x=>parseInt(x,16)); return `rgba(${r},${g},${b},${alpha})`; };
            const timeToDecimal = (t) => { if (!t) return null; const [h,m] = t.split(':').map(Number); return h < 12 ? h + 24 + m / 60 : h + m / 60; };
            const decimalToTime = (d) => { if (!d) return 'N/A'; const h = Math.floor(d)%24, m = Math.round((d%1)*60); return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; };
            const getContrastColor = (hex) => { if(!hex) return '#FFFFFF'; const [r,g,b] = hex.match(/\w\w/g).map(x => parseInt(x, 16)); return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#000000' : '#FFFFFF'; };

            // --- FIXED HELPER FUNCTIONS ---

            const scoreToPercentage = (score, stops) => {
                const allScores = stops.map(s => s.score);
                const minScore = Math.min(...allScores);
                const maxScore = Math.max(...allScores);

                const scoreRange = maxScore - minScore;
                if (scoreRange === 0) return 50;

                const boundedScore = Math.max(minScore, Math.min(score, maxScore));

                return ((boundedScore - minScore) / scoreRange) * 100;
            };

            const getColorForScore = (score, stops) => {
                const sortedStops = [...stops].sort((a, b) => a.score - b.score);

                if (score <= sortedStops[0].score) return sortedStops[0].color;
                if (score >= sortedStops[sortedStops.length - 1].score) return sortedStops[sortedStops.length - 1].color;

                let stop1, stop2;
                for (let i = 0; i < sortedStops.length - 1; i++) {
                    if (score >= sortedStops[i].score && score <= sortedStops[i+1].score) {
                        stop1 = sortedStops[i];
                        stop2 = sortedStops[i+1];
                        break;
                    }
                }

                const range = stop2.score - stop1.score;
                const ratio = range === 0 ? 0 : (score - stop1.score) / range;

                const r1 = parseInt(stop1.color.slice(1,3), 16), g1 = parseInt(stop1.color.slice(3,5), 16), b1 = parseInt(stop1.color.slice(5,7), 16);
                const r2 = parseInt(stop2.color.slice(1,3), 16), g2 = parseInt(stop2.color.slice(3,5), 16), b2 = parseInt(stop2.color.slice(5,7), 16);

                const R = Math.round(r1 * (1-ratio) + r2 * ratio);
                const G = Math.round(g1 * (1-ratio) + g2 * ratio);
                const B = Math.round(b1 * (1-ratio) + b2 * ratio);

                return `rgb(${R}, ${G}, ${B})`;
            };

            function setupPointers(prefix, lastScore, avgScore, stops) {
                const lastPointer = document.getElementById(`${prefix}-last-pointer`);
                const avgPointer = document.getElementById(`${prefix}-avg-pointer`);

                lastPointer.style.left = `${scoreToPercentage(lastScore, stops)}%`;
                avgPointer.style.left = `${scoreToPercentage(avgScore, stops)}%`;

                lastPointer.style.borderTopColor = getColorForScore(lastScore, stops);
                avgPointer.style.borderBottomColor = getColorForScore(avgScore, stops);

                const lastLabel = lastPointer.querySelector('.pointer-label');
                const avgLabel = avgPointer.querySelector('.pointer-label');

                if (lastLabel) lastLabel.textContent = `Last: ${lastScore.toFixed(2)}`;
                if (avgLabel) avgLabel.textContent = `Avg: ${avgScore.toFixed(2)}`;
            }

            function updateGradientBar(prefix, stops) {
                const gradientString = [...stops]
                    .sort((a, b) => a.score - b.score)
                    .map(stop =>
                        `${stop.color} ${scoreToPercentage(stop.score, stops)}%`
                    )
                    .join(', ');

                const bar = document.querySelector(`#${prefix}-summary .score-scale-bar`);
                if(bar) bar.style.background = `linear-gradient(to right, ${gradientString})`;
            }

            // --- Setup Section for SLEEP ---
            if (chartData && chartData.sleep) {
                const sleepData = chartData.sleep;
                updateGradientBar('sleep', sleepData.colorStops);
                setupPointers('sleep', sleepData.latestScore, sleepData.averageScore, sleepData.colorStops);
                createSleepCharts(sleepData);
            }

            // --- Setup Section for VO2 MAX ---
            if (chartData && chartData.vo2) {
                const vo2Data = chartData.vo2;
                updateGradientBar('vo2', vo2Data.colorStops);
                setupPointers('vo2', vo2Data.latestScore, vo2Data.averageScore, vo2Data.colorStops);
                createVo2MaxChart(vo2Data);
            }

            // --- Chart Creation Functions ---
            function createSleepCharts(sleepData) {
                const allScores = sleepData.colorStops.map(s => s.score);
                const minScore = Math.min(...allScores);
                const maxScore = Math.max(...allScores);
                const defaultDatalabels = { anchor: 'center', align: 'center', font: { weight: 'bold', size: 14 }, color: (c) => getContrastColor(sleepData.daily[c.dataIndex].consistencyColor), formatter: (v,c) => parseFloat(c.chart.options.plugins.datalabels.scores[c.dataIndex]).toFixed(2) };
                const isTimeBased = sleepData.daily.length > 0 && sleepData.daily[0].sleepTime;

                // Handle missing days - filter out days without data for consistency chart
                const validDays = sleepData.daily.filter(d => d.hasData);
                const consistencyData = isTimeBased ? validDays.map(d => [timeToDecimal(d.sleepTime), timeToDecimal(d.wakeTime)]) : validDays.map(d => d.consistencyScore);
                const consistencyTooltip = isTimeBased ? c => `Slept from ${decimalToTime(c.raw[0])} to ${decimalToTime(c.raw[1])}` : c => `Score: ${parseFloat(c.raw).toFixed(2)}`;
                const consistencyYScale = isTimeBased ? { min: 20, max: 34, ticks: { stepSize: 1, color: '#aaa', callback: v => decimalToTime(v) }} : {min: minScore, max: maxScore, ticks: { color: '#aaa', callback: v => v.toFixed(2)}};

                const durationData = isTimeBased ? validDays.map(d => timeToDecimal(d.wakeTime) - timeToDecimal(d.sleepTime)) : validDays.map(d => d.durationScore);
                const durationYScale = isTimeBased ? { beginAtZero: true, title: { display: true, text: 'Hours', color: '#aaa' }, ticks: { color: '#aaa' }} : {min: minScore, max: maxScore, title: { display: true, text: 'Score', color: '#aaa' }, ticks: { color: '#aaa', callback: v => v.toFixed(2)}};

                // Create sleep time chart (sleep times at top)
                const sleepTimeData = validDays.map(d => timeToDecimal(d.sleepTime));
                const wakeTimeData = validDays.map(d => timeToDecimal(d.wakeTime));
                
                new Chart('sleep-consistency-chart', { 
                    type: 'bar', 
                    data: { 
                        labels: validDays.map(d => d.label),
                        datasets: [
                            {
                                label: 'Sleep Time',
                                data: sleepTimeData,
                                backgroundColor: validDays.map(d => hexToRgba(d.consistencyColor, 0.6)),
                                borderColor: validDays.map(d => d.consistencyColor),
                                borderWidth: 1.5,
                                borderSkipped: false
                            },
                            {
                                label: 'Wake Time', 
                                data: wakeTimeData,
                                backgroundColor: validDays.map(d => hexToRgba(d.durationColor, 0.6)),
                                borderColor: validDays.map(d => d.durationColor),
                                borderWidth: 1.5,
                                borderSkipped: false
                            }
                        ]
                    }, 
                    options: { 
                        scales: { 
                            y: { 
                                min: 20, 
                                max: 34, 
                                ticks: { 
                                    stepSize: 1, 
                                    color: '#aaa', 
                                    callback: v => decimalToTime(v) 
                                }
                            }, 
                            x: { 
                                labels: validDays.map(d => d.label), 
                                ticks: { color: '#aaa' }
                            } 
                        }, 
                        plugins: { 
                            legend: { display: true, position: 'top' }, 
                            tooltip: { 
                                callbacks: { 
                                    label: c => `${c.dataset.label}: ${decimalToTime(c.raw)}` 
                                }
                            }, 
                            datalabels: { 
                                display: false // Hide data labels for cleaner look
                            }
                        }
                    }
                });

                // Duration chart (sleep duration)
                new Chart('sleep-duration-chart', { 
                    type: 'bar', 
                    data: { 
                        labels: validDays.map(d => d.label),
                        datasets: [{ 
                            data: durationData, 
                            backgroundColor: validDays.map(d => hexToRgba(d.durationColor, 0.6)), 
                            borderColor: validDays.map(d => d.durationColor), 
                            borderWidth: 1.5 
                        }] 
                    }, 
                    options: { 
                        scales: { 
                            y: durationYScale, 
                            x: { 
                                labels: validDays.map(d => d.label), 
                                ticks: { color: '#aaa' }
                            } 
                        }, 
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                callbacks: { 
                                    label: c => `${isTimeBased ? 'Hours' : 'Score'}: ${parseFloat(c.raw).toFixed(2)}` 
                                }
                            }, 
                            datalabels: { 
                                ...defaultDatalabels, 
                                scores: validDays.map(d => d.durationScore) 
                            }
                        }
                    }
                });
            }

            function createVo2MaxChart(vo2Data) {
                const dailyData = vo2Data.daily;
                const zones = vo2Data.zones || []; // Get zones from your data, default to empty array

                // Dynamically determine the Y-axis range to fit all data points and zone lines
                const allYValues = [...dailyData.map(d => d.vo2), ...zones.map(z => z.value)];
                const yMax = Math.ceil(Math.max(...allYValues)) + 2;
                const yMin = Math.floor(Math.min(...allYValues)) - 2;

                // --- ANNOTATION LOGIC ---
                const annotations = {};
                if (zones.length > 0) {
                    const sortedZones = [...zones].sort((a, b) => a.value - b.value);
                    let currentYMin = yMin;

                    sortedZones.forEach((zone, index) => {
                        annotations[`box${index}`] = {
                            type: 'box',
                            yScaleID: 'y',
                            yMin: currentYMin,
                            yMax: zone.value,
                            backgroundColor: zone.color,
                            borderWidth: 0,
                            drawTime: 'beforeDatasetsDraw'
                        };
                        currentYMin = zone.value;
                    });

                    annotations.box_top = {
                        type: 'box',
                        yScaleID: 'y',
                        yMin: currentYMin,
                        yMax: yMax,
                        backgroundColor: sortedZones[sortedZones.length - 1].color,
                        borderWidth: 0,
                        drawTime: 'beforeDatasetsDraw'
                    };
                }
                // --- END OF ANNOTATION LOGIC ---

                new Chart('vo2-max-chart', {
                    type: 'line',
                    data: {
                        labels: dailyData.map(d => d.date),
                        datasets: [{
                            data: dailyData.map(d => d.vo2),
                            borderColor: '#64b5f6',
                            backgroundColor: hexToRgba('#64b5f6', 0.2),
                            fill: true,
                            pointBackgroundColor: '#FFFFFF',
                            pointBorderColor: '#64b5f6',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.1
                        }]
                    },
                    options: {
                        animation: false, // <--- This line disables animations for the chart
                        scales: {
                            y: { min: yMin, max: yMax, title: { display: true, text: 'VO2 Max', color: '#aaa' }, ticks: { color: '#aaa' } },
                            x: { ticks: { color: '#aaa' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: c => `VO2 Max: ${parseFloat(c.raw).toFixed(2)}` } },
                            datalabels: { anchor: 'end', align: 'top', color: '#ccc', formatter: (v) => parseFloat(v).toFixed(2) },
                            annotation: {
                                annotations: annotations
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
