<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1, h2, h3 { color: #ffffff; font-weight: 500; }
        .metric-wrapper { margin-bottom: 20px; }

        .summary-item {
            background-color: #1e1e1e;
            padding: 20px 25px 30px;
            border-radius: 12px;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;

            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 190px;
        }

        .summary-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }

        .summary-item h2 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-scale-container {
            position: relative;
            height: 80px;
            margin: 0;
            flex-shrink: 0;
        }

        .scale-wrapper {
            position: relative;
            height: 100%;
            margin: 0 45px;
        }

        .score-scale-bar { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; height: 10px; border-radius: 5px; }
        .scale-pointer { position: absolute; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }

        .pointer-avg { top: 5px; border-bottom: 12px solid; }
        .pointer-last { top: 63px; border-top: 12px solid; }

        .pointer-label {
            font-size: 0.8em;
            color: #ccc;
            background-color: rgba(0,0,0,0.8);
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .pointer-avg .pointer-label { position: absolute; bottom: 14px; transform: translateX(-50%); }
        .pointer-last .pointer-label { position: absolute; top: 14px; transform: translateX(-50%); }

        .details-container { display: none; flex-direction: column; gap: 30px; margin-top: 20px; }
        .details-container.visible { display: flex; }
        .chart-wrapper { background-color: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .chart-subtitle { margin-top: -10px; margin-bottom: 20px; font-size: 0.9em; color: #999; }
        .vo2-chart-container { position: relative; }
        .vo2-gradient-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; border-radius: 8px; z-index: 1; }
        #vo2-max-chart { position: relative; z-index: 2; }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <h1>Health Analysis</h1>

        <div class="metric-wrapper">
            <div id="sleep-summary" class="summary-item">
                <h2>Sleep Score ðŸ˜´</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="sleep-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="sleep-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="sleep-details" class="details-container">
                <div class="chart-wrapper"><h3>Sleep Windows</h3><p class="chart-subtitle">Sleep periods showing time in bed. Color indicates sleep consistency.</p><div style="height: 300px; position: relative;"><canvas id="sleep-windows-chart"></canvas></div></div>
                <div class="chart-wrapper"><h3>Sleep Duration</h3><p class="chart-subtitle">Total hours slept each day.</p><div style="height: 300px; position: relative;"><canvas id="sleep-duration-chart"></canvas></div></div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="vo2-summary" class="summary-item">
                <h2>VO2 Max Score ðŸ’ª</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="vo2-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="vo2-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="vo2-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>VO2 Max Trend</h3>
                    <p class="chart-subtitle">Your estimated VO2 max over time. Higher is better.</p>
                    <div class="vo2-chart-container">
                    <canvas id="vo2-max-chart"></canvas>
                        <div id="vo2-gradient-bg" class="vo2-gradient-bg"></div>
                    </div>
                    <div id="vo2-zones-data" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="metric-wrapper">
            <div id="steps-summary" class="summary-item">
                <h2>Steps Score ðŸš¶</h2>
                <div class="score-scale-container">
                    <div class="scale-wrapper">
                        <div class="score-scale-bar"></div>
                        <div id="steps-last-pointer" class="scale-pointer pointer-last"><div class="pointer-label">Last</div></div>
                        <div id="steps-avg-pointer" class="scale-pointer pointer-avg"><div class="pointer-label">Avg</div></div>
                    </div>
                </div>
            </div>
            <div id="steps-details" class="details-container">
                <div class="chart-wrapper">
                    <h3>Daily Steps</h3>
                    <p class="chart-subtitle">Daily steps with 7-day rolling average. Color indicates health risk based on steps.</p>
                    <canvas id="steps-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA PLACEHOLDER (To be replaced by Python) ---
        const chartData = {
    "sleep": {
        "latestScore": -0.4498056488739588,
        "averageScore": 0.0858953019396913,
        "daily": [
            {
                "label": "Sep 21",
                "consistencyScore": 1.28,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:23",
                "wakeTime": "06:57",
                "sleepDuration": 7.566666666666666,
                "timeInBed": 7.6499999999999995,
                "awakeCount": 0,
                "hasData": true
            },
            {
                "label": "Sep 22",
                "consistencyScore": 1.28,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:19",
                "wakeTime": "06:52",
                "sleepDuration": 7.55,
                "timeInBed": 7.733333333333333,
                "awakeCount": 0,
                "hasData": true
            },
            {
                "label": "Sep 23",
                "consistencyScore": 1.094749683143219,
                "durationScore": 0.93,
                "consistencyColor": "#e53935",
                "durationColor": "#43a047",
                "sleepTime": "23:37",
                "wakeTime": "09:01",
                "sleepDuration": 9.4,
                "timeInBed": 10.15,
                "awakeCount": 2,
                "hasData": true
            },
            {
                "label": "Sep 24",
                "consistencyScore": 0.9640504334121355,
                "durationScore": 0.93,
                "consistencyColor": "#77ba7a",
                "durationColor": "#43a047",
                "sleepTime": "22:38",
                "wakeTime": "06:21",
                "sleepDuration": 7.716666666666667,
                "timeInBed": 8.183333333333334,
                "awakeCount": 2,
                "hasData": true
            },
            {
                "label": "Sep 25",
                "consistencyScore": 0.9725873391121618,
                "durationScore": 0.93,
                "consistencyColor": "#97ca9a",
                "durationColor": "#43a047",
                "sleepTime": "23:50",
                "wakeTime": "08:01",
                "sleepDuration": 8.183333333333334,
                "timeInBed": 8.75,
                "awakeCount": 1,
                "hasData": true
            },
            {
                "label": "Sep 26",
                "consistencyScore": 0.97324402416601,
                "durationScore": 0.93,
                "consistencyColor": "#9acc9c",
                "durationColor": "#43a047",
                "sleepTime": "23:51",
                "wakeTime": "07:05",
                "sleepDuration": 7.233333333333333,
                "timeInBed": 7.566666666666666,
                "awakeCount": 1,
                "hasData": true
            },
            {
                "label": "Sep 27",
                "consistencyScore": 0.9693039138429208,
                "durationScore": 0.9852631578947368,
                "consistencyColor": "#8bc48e",
                "durationColor": "#c7e3c8",
                "sleepTime": "00:45",
                "wakeTime": "07:39",
                "sleepDuration": 6.9,
                "timeInBed": 7.2,
                "awakeCount": 1,
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "vo2": {
        "latestScore": -4.6,
        "averageScore": -4.6,
        "daily": [
            {
                "date": "Sep 28",
                "vo2": 53.8
            },
            {
                "date": "Sep 27",
                "vo2": 53.8
            },
            {
                "date": "Sep 26",
                "vo2": 53.8
            },
            {
                "date": "Sep 25",
                "vo2": 53.8
            },
            {
                "date": "Sep 24",
                "vo2": 53.7
            },
            {
                "date": "Sep 23",
                "vo2": 53.7
            },
            {
                "date": "Sep 22",
                "vo2": 53.8
            }
        ],
        "zones": [
            {
                "value": 36.05,
                "color": "#e53935"
            },
            {
                "value": 38.85,
                "color": "#e53935"
            },
            {
                "value": 44.8,
                "color": "#ffffff"
            },
            {
                "value": 51.28,
                "color": "#43a047"
            },
            {
                "value": 54.95,
                "color": "#43a047"
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    },
    "steps": {
        "latestScore": 0.0,
        "averageScore": 0.0,
        "daily": [
            {
                "label": "Sep 22",
                "dailySteps": 19830,
                "rollingAvgSteps": 12691,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 23",
                "dailySteps": 13505,
                "rollingAvgSteps": 13501,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 24",
                "dailySteps": 6792,
                "rollingAvgSteps": 12422,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 25",
                "dailySteps": 25764,
                "rollingAvgSteps": 15698,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 26",
                "dailySteps": 7577,
                "rollingAvgSteps": 15990,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 27",
                "dailySteps": 17768,
                "rollingAvgSteps": 13898,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            },
            {
                "label": "Sep 28",
                "dailySteps": 3774,
                "rollingAvgSteps": 13572,
                "hazardRatio": 1.0,
                "hrColor": "#ffffff",
                "hasData": true
            }
        ],
        "colorStops": [
            {
                "score": 2,
                "color": "#d32f2f"
            },
            {
                "score": 1,
                "color": "#f57c00"
            },
            {
                "score": 0,
                "color": "#ffffff"
            },
            {
                "score": -1,
                "color": "#7cb342"
            },
            {
                "score": -2,
                "color": "#388e3c"
            }
        ]
    }
};

        document.addEventListener('DOMContentLoaded', function() {
            Chart.register(ChartDataLabels);

            // --- Accordion Click Logic ---
            document.querySelectorAll('.summary-item').forEach(summary => {
                summary.addEventListener('click', function() {
                    const detailsId = this.id.replace('-summary', '-details');
                    const detailsEl = document.getElementById(detailsId);
                    if (!detailsEl) return;
                    const isAlreadyVisible = detailsEl.classList.contains('visible');
                    document.querySelectorAll('.details-container').forEach(d => d.classList.remove('visible'));
                    if (!isAlreadyVisible) detailsEl.classList.add('visible');
                });
            });

            // --- Reusable Helper Functions ---
            const hexToRgba = (hex, alpha=1) => { if(!hex) return 'rgba(136,136,136,0.6)'; const [r,g,b] = hex.match(/\w\w/g).map(x=>parseInt(x,16)); return `rgba(${r},${g},${b},${alpha})`; };
            const timeToDecimal = (t) => { if (!t) return null; const [h,m] = t.split(':').map(Number); return h + m / 60; };
            const decimalToTime = (d) => { if (!d) return 'N/A'; const h = Math.floor(d)%24, m = Math.round((d%1)*60); return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; };
            const getContrastColor = (hex) => { if(!hex) return '#FFFFFF'; const [r,g,b] = hex.match(/\w\w/g).map(x => parseInt(x, 16)); return (r * 0.299 + g * 0.587 + b * 0.114) > 186 ? '#000000' : '#FFFFFF'; };

            // --- FIXED HELPER FUNCTIONS ---

            const scoreToPercentage = (score, stops) => {
                const allScores = stops.map(s => s.score);
                const minScore = Math.min(...allScores);
                const maxScore = Math.max(...allScores);

                const scoreRange = maxScore - minScore;
                if (scoreRange === 0) return 50;

                const boundedScore = Math.max(minScore, Math.min(score, maxScore));

                return ((boundedScore - minScore) / scoreRange) * 100;
            };

            const getColorForScore = (score, stops) => {
                const sortedStops = [...stops].sort((a, b) => a.score - b.score);

                if (score <= sortedStops[0].score) return sortedStops[0].color;
                if (score >= sortedStops[sortedStops.length - 1].score) return sortedStops[sortedStops.length - 1].color;

                let stop1, stop2;
                for (let i = 0; i < sortedStops.length - 1; i++) {
                    if (score >= sortedStops[i].score && score <= sortedStops[i+1].score) {
                        stop1 = sortedStops[i];
                        stop2 = sortedStops[i+1];
                        break;
                    }
                }

                const range = stop2.score - stop1.score;
                const ratio = range === 0 ? 0 : (score - stop1.score) / range;

                const r1 = parseInt(stop1.color.slice(1,3), 16), g1 = parseInt(stop1.color.slice(3,5), 16), b1 = parseInt(stop1.color.slice(5,7), 16);
                const r2 = parseInt(stop2.color.slice(1,3), 16), g2 = parseInt(stop2.color.slice(3,5), 16), b2 = parseInt(stop2.color.slice(5,7), 16);

                const R = Math.round(r1 * (1-ratio) + r2 * ratio);
                const G = Math.round(g1 * (1-ratio) + g2 * ratio);
                const B = Math.round(b1 * (1-ratio) + b2 * ratio);

                return `rgb(${R}, ${G}, ${B})`;
            };

            function setupPointers(prefix, lastScore, avgScore, stops) {
                const lastPointer = document.getElementById(`${prefix}-last-pointer`);
                const avgPointer = document.getElementById(`${prefix}-avg-pointer`);

                lastPointer.style.left = `${scoreToPercentage(lastScore, stops)}%`;
                avgPointer.style.left = `${scoreToPercentage(avgScore, stops)}%`;

                lastPointer.style.borderTopColor = getColorForScore(lastScore, stops);
                avgPointer.style.borderBottomColor = getColorForScore(avgScore, stops);

                const lastLabel = lastPointer.querySelector('.pointer-label');
                const avgLabel = avgPointer.querySelector('.pointer-label');

                if (lastLabel) lastLabel.textContent = `Last: ${lastScore.toFixed(2)}`;
                if (avgLabel) avgLabel.textContent = `Avg: ${avgScore.toFixed(2)}`;
            }

            function updateGradientBar(prefix, stops) {
                const gradientString = [...stops]
                    .sort((a, b) => a.score - b.score)
                    .map(stop =>
                        `${stop.color} ${scoreToPercentage(stop.score, stops)}%`
                    )
                    .join(', ');

                const bar = document.querySelector(`#${prefix}-summary .score-scale-bar`);
                if(bar) bar.style.background = `linear-gradient(to right, ${gradientString})`;
            }

            // --- Setup Section for SLEEP ---
            if (chartData && chartData.sleep) {
                const sleepData = chartData.sleep;
                updateGradientBar('sleep', sleepData.colorStops);
                setupPointers('sleep', sleepData.latestScore, sleepData.averageScore, sleepData.colorStops);
                createSleepCharts(sleepData);
            }

            // --- Setup Section for VO2 MAX ---
            if (chartData && chartData.vo2) {
                const vo2Data = chartData.vo2;
                updateGradientBar('vo2', vo2Data.colorStops);
                setupPointers('vo2', vo2Data.latestScore, vo2Data.averageScore, vo2Data.colorStops);
                createVo2MaxChart(vo2Data);
            }

            // --- Setup Section for STEPS ---
            if (chartData && chartData.steps) {
                const stepsData = chartData.steps;
                updateGradientBar('steps', stepsData.colorStops);
                setupPointers('steps', stepsData.latestScore, stepsData.averageScore, stepsData.colorStops);
                createStepsChart(stepsData);
            }

            // --- Chart Creation Functions ---
            function createSleepCharts(sleepData) {
                // Handle missing days - filter out days without data
                const validDays = sleepData.daily.filter(d => d.hasData);

                // Create forest plot-style sleep windows chart
                const sleepWindowsData = validDays.map(d => {
                    const sleepTime = timeToDecimal(d.sleepTime);
                    const wakeTime = timeToDecimal(d.wakeTime);
                    const timeInBed = d.timeInBed || d.sleepDuration || 0; // Use actual time in bed

                    // Calculate the actual end time (sleep time + time in bed)
                    let endTime = sleepTime + timeInBed;

                    // Handle day rollover (if sleep goes past midnight)
                    if (endTime >= 24) {
                        endTime = endTime - 24;
                    }

                    return {
                        sleepTime: sleepTime,
                        wakeTime: wakeTime,
                        timeInBed: timeInBed,
                        endTime: endTime,
                        consistencyScore: d.consistencyScore,
                        awakeCount: d.awakeCount || 0
                    };
                });

                // Create horizontal bar chart for sleep windows (forest plot style)
                new Chart('sleep-windows-chart', {
                    type: 'bar',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [{
                            label: 'Sleep Window',
                            data: sleepWindowsData.map(d => d.endTime),
                            backgroundColor: sleepWindowsData.map(d => {
                                // Color based on SleepConsistencyIndexHR
                                const score = d.consistencyScore || 1.0;
                                if (score <= 0.9) return '#4caf50'; // Green for good consistency
                                if (score >= 1.5) return '#f44336'; // Red for poor consistency

                                // Gradient between green and red for middle values
                                const ratio = (score - 0.9) / (1.5 - 0.9);
                                const r = Math.round(76 + (244 - 76) * ratio);
                                const g = Math.round(175 + (67 - 175) * ratio);
                                const b = Math.round(80 + (54 - 80) * ratio);
                                return `rgb(${r}, ${g}, ${b})`;
                            }),
                            borderColor: sleepWindowsData.map(d => {
                                const score = d.consistencyScore || 1.0;
                                if (score <= 0.9) return '#2e7d32';
                                if (score >= 1.5) return '#c62828';

                                const ratio = (score - 0.9) / (1.5 - 0.9);
                                const r = Math.round(46 + (198 - 46) * ratio);
                                const g = Math.round(125 + (40 - 125) * ratio);
                                const b = Math.round(50 + (40 - 50) * ratio);
                                return `rgb(${r}, ${g}, ${b})`;
                            }),
                            borderWidth: 1.5,
                            barThickness: 12,
                            // Bar starts at sleep time
                            base: sleepWindowsData.map(d => d.sleepTime)
                        }]
                    },
                    options: {
                        animation: false, // Disable animations to prevent resizing issues
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Horizontal bars
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10
                            }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: 24,
                                title: {
                                    display: true,
                                    text: 'Time of Day',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    stepSize: 2,
                                    callback: function(value) {
                                        // Convert decimal hours to time format
                                        const hours = Math.floor(value);
                                        const minutes = Math.round((value - hours) * 60);
                                        const displayHours = hours % 24;
                                        return `${String(displayHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                    }
                                }
                            },
                            y: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const dataIndex = context.dataIndex;
                                        const day = validDays[dataIndex];
                                        const window = sleepWindowsData[dataIndex];
                                        return [
                                            `Sleep Consistency: ${window.consistencyScore ? window.consistencyScore.toFixed(2) : 'N/A'}`,
                                            `Awake Count: ${window.awakeCount}`,
                                            `Sleep Time: ${decimalToTime(window.sleepTime)}`,
                                            `End Time: ${decimalToTime(window.endTime)}`,
                                            `Time in Bed: ${window.timeInBed.toFixed(1)}h`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });

                // Duration chart - simple bar chart showing hours slept
                const durationData = validDays.map(d => d.sleepDuration || 0);

                new Chart('sleep-duration-chart', {
                    type: 'bar',
                    data: {
                        labels: validDays.map(d => d.label),
                        datasets: [{
                            label: 'Hours Slept',
                            data: durationData,
                            backgroundColor: validDays.map(d => hexToRgba(d.durationColor, 0.6)),
                            borderColor: validDays.map(d => d.durationColor),
                            borderWidth: 1.5
                        }]
                    },
                    options: {
                        animation: false, // Disable animations to prevent resizing issues
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    callback: function(value) {
                                        return value.toFixed(1) + 'h';
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Hours Slept: ${context.raw.toFixed(1)}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            }

            function createVo2MaxChart(vo2Data) {
                const dailyData = vo2Data.daily;
                const zones = vo2Data.zones || []; // Get zones from your data, default to empty array

                // Dynamically determine the Y-axis range to fit all data points and zone lines
                const allYValues = [...dailyData.map(d => d.vo2), ...zones.map(z => z.value)];
                const yMax = Math.ceil(Math.max(...allYValues)) + 2;
                const yMin = Math.floor(Math.min(...allYValues)) - 2;

                // --- GRADIENT BACKGROUND LOGIC ---
                const annotations = {};

                // Create gradient background for VO2 chart
                if (zones.length > 0) {
                    const sortedZones = [...zones].sort((a, b) => a.value - b.value);
                    const gradientElement = document.getElementById('vo2-gradient-bg');

                    if (gradientElement) {
                        // Create CSS gradient string
                        const gradientStops = sortedZones.map((zone, index) => {
                            const percentage = ((zone.value - yMin) / (yMax - yMin)) * 100;
                            return `${zone.color} ${percentage}%`;
                        }).join(', ');

                        gradientElement.style.background = `linear-gradient(to top, ${gradientStops})`;
                    }
                }
                // --- END OF GRADIENT BACKGROUND LOGIC ---

                new Chart('vo2-max-chart', {
                    type: 'line',
                    data: {
                        labels: dailyData.map(d => d.date),
                        datasets: [{
                            data: dailyData.map(d => d.vo2),
                            borderColor: '#64b5f6',
                            backgroundColor: hexToRgba('#64b5f6', 0.2),
                            fill: true,
                            pointBackgroundColor: '#FFFFFF',
                            pointBorderColor: '#64b5f6',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.1
                        }]
                    },
                    options: {
                        animation: false, // <--- This line disables animations for the chart
                        scales: {
                            y: { min: yMin, max: yMax, title: { display: true, text: 'VO2 Max', color: '#aaa' }, ticks: { color: '#aaa' } },
                            x: { ticks: { color: '#aaa' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: c => `VO2 Max: ${parseFloat(c.raw).toFixed(2)}` } },
                            datalabels: { anchor: 'end', align: 'top', color: '#ccc', formatter: (v) => parseFloat(v).toFixed(2) }
                        }
                    }
                });
            }

            function createStepsChart(stepsData) {
                const dailyData = stepsData.daily;
                const labels = dailyData.map(d => d.label);
                const dailySteps = dailyData.map(d => d.dailySteps);
                const rollingAvgSteps = dailyData.map(d => d.rollingAvgSteps);
                const hrColors = dailyData.map(d => d.hrColor);

                new Chart('steps-chart', {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Daily Steps',
                                data: dailySteps,
                                backgroundColor: hrColors,
                                borderColor: hrColors,
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '7-Day Rolling Average',
                                data: rollingAvgSteps,
                                type: 'line',
                                borderColor: '#ff9800',
                                backgroundColor: 'transparent',
                                pointBackgroundColor: '#ff9800',
                                pointBorderColor: '#ff9800',
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.1,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        animation: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Steps',
                                    color: '#aaa'
                                },
                                ticks: {
                                    color: '#aaa',
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#aaa',
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Daily Steps: ${context.raw.toLocaleString()}`;
                                        } else {
                                            return `Rolling Average: ${context.raw.toLocaleString()}`;
                                        }
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
